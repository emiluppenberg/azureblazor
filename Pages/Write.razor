@page "/write"
@inject HttpClient httpClient
@inject IConfiguration Configuration

<PageTitle>Write</PageTitle>

<div class="card shadow-sm">
    <div class="card-body">

        <form @onsubmit="async () => await HandleSubmit()" novalidate>
            <div class="mb-3">
                <label for="studentName" class="form-label fw-semibold">Full Name</label>
                <input type="text" class="form-control" id="studentName" placeholder="Enter student name"
                    @bind="NewStudent.Name" @bind:event="oninput" required>
                <div class="invalid-feedback">Please enter a name.</div>
            </div>

            <div class="mb-3">
                <label for="studentAge" class="form-label fw-semibold">Age</label>
                <input type="number" class="form-control" id="studentAge" min="16" max="100" @bind="NewStudent.Age"
                    @bind:event="oninput" required>
                <div class="invalid-feedback">Age must be between 16 and 100.</div>
            </div>

            <div class="mb-4">
                <label for="courseSelect" class="form-label fw-semibold">Select Course</label>
                <select class="form-select" id="courseSelect" @bind="NewStudent.CourseId" required>
                    <option value="0" disabled selected>Choose a course...</option>
                    @if (AvailableCourses is not null)
                    {
                        @foreach (var course in AvailableCourses)
                        {
                            <option value="@course.Id">@course.Name</option>
                        }
                    }
                    else
                    {
                        <option disabled>Loading...</option>
                    }
                </select>
                <div class="invalid-feedback">Please select a course.</div>

                @if (NewStudent.CourseId > 0)
                {
                    var selectedCourse = AvailableCourses.FirstOrDefault(c => c.Id == NewStudent.CourseId);
                    <div class="mt-2 text-success">
                        <small>Selected: <strong>@selectedCourse?.Name</strong></small>
                    </div>
                }
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="bi bi-person-plus me-2"></i>Add Student
                </button>
            </div>

            @if (ShowSuccess is not null)
            {
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    @ShowSuccess
                    <button type="button" class="btn-close" @onclick="() => { ShowSuccess = null; }"></button>
                </div>
            }
            @if (ShowError is not null)
            {
                <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    @ShowError
                    <button type="button" class="btn-close" @onclick="() => { ShowError = null; }"></button>
                </div>
            }
        </form>
    </div>
</div>

@code {
    public StudentDTO NewStudent { get; set; } = new();
    public List<CourseDTO>? AvailableCourses { get; set; }
    public string? ShowSuccess { get; set; }
    public string? ShowError { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var response = await httpClient.GetAsync($"{Configuration["ApiBaseUrl"]}/courses");
        response.EnsureSuccessStatusCode();

        AvailableCourses = await response.Content.ReadFromJsonAsync<List<CourseDTO>>();
    }

    async Task HandleSubmit()
    {
        try
        {
            var response = await httpClient.PostAsJsonAsync($"{Configuration["ApiBaseUrl"]}/add-student", NewStudent);
            response.EnsureSuccessStatusCode();

            ShowSuccess = $"{NewStudent.Name} has been added to course {AvailableCourses.Find(x => x.Id == NewStudent.CourseId).Name}";
            NewStudent = new();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            ShowError = ex.Message;
        }
    }
}